# Uwazi Development Container (not for production!)

# https://getfedora.org
FROM fedora:30

# Initially built for Huridocs by Google, later maintained by the Huridocs community
LABEL maintainer="vorburger@google.com"

# Update base image (the public one is typically outdated and contains already patched security vulnerabilities)
RUN dnf update -y

# Install utility packages generally useful in any devshell
RUN dnf install -y git findutils less which \

# Install system packages specifically required by Uwazi
    libpng12-devel libpng-devel

# Create ~uwazi and switch to it (without this, Node & Co. would get installed as root)
RUN useradd uwazi
USER uwazi

# Install Node.JS
# Due to https://github.com/nodesource/distributions/issues/842, NOT https://github.com/nodesource/distributions/#rpminstall
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.0/install.sh | bash
RUN source $HOME/.nvm/nvm.sh  \
 && nvm install 8.11 \
 && node --version

# Install Yarn
# https://yarnpkg.com/en/docs/install
# use simple installation script method instead of OS package,
# because package manager dependencies are a mess if Node is installed by NVM instead of package (above)
RUN source $HOME/.nvm/nvm.sh \
 && curl -o- -L https://yarnpkg.com/install.sh | bash \
 && $HOME/.yarn/bin/yarn --version

RUN mkdir /home/uwazi/git
WORKDIR /home/uwazi/git
# TODO rm git clone and replace with mounting from host
RUN git clone https://github.com/huridocs/uwazi.git . \
 && source $HOME/.nvm/nvm.sh \
 && $HOME/.yarn/bin/yarn install
# TODO!  && $HOME/.yarn/bin/yarn test

# TODO document how to run tests in-container, after changing code (need to use CMD instead of ENTRYPOINT?)
ENTRYPOINT source $HOME/.nvm/nvm.sh \
 && $HOME/.yarn/bin/yarn hot
